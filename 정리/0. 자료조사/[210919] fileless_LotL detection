파일 리스
악성코드가 시스템 메모리에 곧바로 로드, 실행되고 하드 디스크에 파일 상태로 존재하지 않음
웹페이지에 들어가기만 해도 작동
사용자 웹브라우저 프로세스에 대하여 메모리에서 payload하여 프로그램 실행
감염 장소는 레지스트리와 메모리와 같은 장소를 이용
이미 설치되어 있거나 OS에서 제공하는 애플리케이션을 이용하기 때문에 기존 보안 솔루션에 탐지 불가 (부분적으로만 탐지 가능)
엑셀이나 워드 같은 애플리케이션에서 실행되는 파일리스 공격은 엑셀이 다운로드 되거나 실행될 때 AV 솔루현에서 탐지 및 차단할 수 있지만
시그니처 매칭 방식은 항상 새로운 패턴에 대한 업로드가 필요하기 때문에 탐지 효율성이 떨어짐
사용자가 실행한 엑셀에서 악성코드가 실행되기 때문에 탐지 및 차단되지 않으면 악성코드는 공격의 다음 단계로 넘어감
방어법 : 지능적으로 대응하는 EDR이 필요
로깅 - 파워쉘 스크립트 블록 로깅
로컬 그룹정책 편집기를 통해 스크립트 블록 로깅 켜기를 설정하면 파워쉘 원 라이너가 실행하게 되고 파워쉘 원라이너의 스크립트를 이벤트 로그에서 확보할 수 있음

Living off the land
LotL 공격 (자급자족 공격)
희생자가 보유한 소프트웨어 및 애플리케이션을 활용하는 공격방식
감시를 통과하기 위해 감시 대상이 아닌 소프트웨어를 이용한 공격방식
윈도우 운영체제에서 제공하는 CMD, 파워쉘, bistadmin 툴이나 curl, wget, Teamview, vnc, nmap 등과 같은 애플리케이션을 활용 
or 애플리케이션의 취약점을 Exploit하여 공격자의 목표를 이룸
정상적인 도구를 활용하는 것으로 시스템으이 정상 활동 범주에 속하게됨
-> Legacy 보안솔루션의 탐지를 어렵게함
방어법 : 1. 애플리케이션 화이트리스트 신중히 사용
2. 윈도우 10 엡라커를 이용, 원하는 애플리케이션만 허용하도록 설정
공격자는 파워셸을 가장 많이 사용 -> "서명된 스크립트만 허용" 정책으로 그룹 정책을 설정해 파워셸을 방어 가능
모듈 로깅, 파워셸 스크립트 블록 로깅, 파워쉘 트랜스크립션에 대한 정책 설정으로 작업 보안을 높임

Sysmon 로그 분석을 통한 위협 탐지
1. 프로세스/파일 생성 행위 탐지
윈도우 OS환경에서 매일 새로운 프로세스가 실행되고 파일이 생성됨
새로 생성된 프로세스나 파일이 다른 애플리케이션에서 생성되었는지 어떤 행위들이 있었는지 식별해야됨

2. 프로세스 상, 하위이상 행위 탐지
프로세스 정보는 상, 하위 형태의 정보를 가짐
Sysmon 툴을 사용하면 상위 프로세스 PPID, 실제 조회 대상 프로세스를 PID로 표기
프로세스 상,하위 정보는 위협 분석에 매우 중요한 정보가 됨
ex) EXCEL.EXE 하위 프로세스로 Powershell.exe 실행되는 것이 확인되면 이것은 특이한 경우이기 때문에 Fileless형태로 의심할 수 있음

3. 네트워크 연결 행위 탐지
Sysmon로그에 출발지 IP, 목적지 IP 및 Port 정보와 해당 통신에 대한 프로세스 상위 프로세스 정보를 가짐
악성코드에 감염된 엔드포인트에서 C&C 서버와 통신을 시도한다면 외부로 네트워크 연결하는 목적지 IP를 확인 가능
정상적이지 않은 내부 호스트 긴 네트워크 연결을 분석, WEB 브라우저나 애플리케이션에서 실행되지 않은 네트워크 정보를 확인해서
위협 분석 정보를 획득가능
ex) notepad.exe.는 일반적으로 통신하지 않는다. 만약 통신하고 있는것을 확인한다면 이것을 의심할 수 있음
위와 같이 정상적이지 않은 프로세스의 통신내역을 확인 할 수 있음
하지만 Sysmon에서는 DPI(Deep Packet Inspection) 정보를 제공하지 않기 때문에 단편적인 로그만으로 위협 탐지는 어려움
그래서 다른 탐지방법과 연관 분석 해야됨

4. 윈도우 명령어 탐지
Living off the land - 탐지 회피를 위해 정상적인 도구를 이용 or 윈도우 명령어를 사용
윈도우 명령어 사용순서, 윈도우 명령어 내용 등을 보고 일반적으로 사용하지 않는 명령어 or 공격자가 주로 사용하는 명령어에 대한 로깅을 확보
해서 확보
ex) 정찰 단계 net관련 명령어,  자료 검색 dir 등
-윈도우 시스템 방화벽 종료 명령어
-방화벽 포트 추가 명령어
-윈도우 예약작업 등록
-레지스트리 변경
이러한 명령어를 쓰면 의심
정상적인 행위에서도 발생할 수 있으므로 사용시간, 횟수, 사용 명령어의 순서 등으로 연관 분석 필요

침입 흔적을 삭제하는 명령어를 사용해서 로그를 삭제할 수도 있음
-> 로그 삭제 명령어가 식별되면 내부 침해를 인지할 수 있음
-> 내부 엔드 포인트에서 사용되는 명령어를 로깅 및 모니터링 하여 침해 사고 전 침해 사구 후 정보를 분석 가능

5. 파일 해시 탐지
Sysmon 로그에서는 파일에 대한 해시값을 생성 및 기록함
지원 해시 - MD5, IMPHASH, SHA 1, SHA 256 지원
공격을 위해서 사용되는 도구, 조직 내 새로운 해시값 발견 시 악성코드인지 아닌지 식별

출처 :
https://www.riss.kr/search/detail/DetailView.do?p_mat_type=be54d9b8bc7cdb09&control_no=0c00a0f999d28bccffe0bdc3ef48d419
- 홍성대 "Sysmon과 ELK Stack를 이용한 윈도우시스템 사이버 위협 탐지 및 가시성 증대에 관한 연구." 국내석사학위논문 동국대학교 대학원, 2020. 서울
https://www.itworld.co.kr/news/147078 - LotL 공격에서 윈도우를 보호하는 방법
https://rninche01.tistory.com/entry/%ED%8C%8C%EC%9D%BC%EB%A6%AC%EC%8A%A4Fileless%EA%B8%B0%EB%B2%95-%EC%84%A4%EB%AA%85-1
- 파일리스 기법 설명

